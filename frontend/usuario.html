<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tienda Virtual</title>

<style>
/* ===================== GLOBAL ===================== */
body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f5;
    color: #000;
    margin: 0;
    padding: 0;
    transition: background-color 0.3s, color 0.3s;
}

h2 {
    text-align: center;
    margin-top: 20px;
    color: #333;
}

/* ===================== HEADER ===================== */
header {
    background: #007bff;
    color: #fff;
    padding: 15px;
    text-align: center;
    position: relative;
}

header h1 {
    margin: 0;
    font-size: 22px;
}

/* Botones en el header */
.header-buttons {
    position: absolute;
    top: 10px;
    right: 15px;
    display: flex;
    gap: 5px;
}

header button {
    padding: 4px 10px;
    border-radius: 5px;
    font-size: 12px;
    border: none;
    cursor: pointer;
    transition: background 0.3s;
}

#btnSalir { background-color: #dc3545; color: #fff; }
#btnSalir:hover { background-color: #c82333; }

#btnTema { background-color: #343a40; color: #fff; }
#btnTema:hover { background-color: #000; }

/* ===================== PRODUCTOS ===================== */
.productos-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin: 20px;
}

.producto-card {
    background-color: #fff;
    width: 220px;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s;
}

.producto-card:hover { transform: scale(1.03); }

.producto-card img {
    width: 180px;
    height: 180px;
    object-fit: cover;
    border-radius: 10px;
}

.producto-card button {
    margin-top: 10px;
    padding: 6px 10px;
    background-color: #28a745;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.producto-card button:hover { background-color: #218838; }

.producto-card input[type="number"] {
    width: 60px;
    padding: 4px;
    margin-top: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

/* ===================== CARRITO / FORMULARIO ===================== */
.carrito, .form-entrega, .pedidos {
    background-color: #fff;
    padding: 15px;
    border-radius: 10px;
    width: 90%;
    max-width: 900px;
    margin: 20px auto;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    transition: background-color 0.3s, color 0.3s;
}

.carrito ul { list-style: none; padding: 0; }

.carrito li {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #ddd;
}

.carrito button {
    padding: 4px 8px;
    background-color: #dc3545;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.carrito button:hover { background-color: #c82333; }

.total {
    text-align: right;
    font-weight: bold;
    margin-top: 10px;
}

#finalizar, #guardar-entrega {
    width: 100%;
    padding: 8px 12px;
    margin-top: 10px;
    border-radius: 5px;
    border: none;
    background-color: #007bff;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
}

#finalizar:hover, #guardar-entrega:hover { background-color: #0056b3; }

.form-entrega input {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}

/* ===================== PEDIDOS ===================== */
.pedidos table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 14px;
    background: #fff;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

.pedidos th, .pedidos td {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
    color: #000; /* Letra negra en tema claro */
}

.pedidos th {
    background-color: #007bff;
    color: white;
    font-weight: bold;
}

.pedidos tbody tr:nth-child(even) { background-color: #f9f9f9; }
.pedidos tbody tr:hover { background-color: #e9f5ff; transition: background 0.3s; }

.pedidos td:last-child { font-weight: bold; color: #28a745; }

/* ===================== TEMA OSCURO ===================== */
body.tema-oscuro {
    background-color: #1c1c1c;
    color: #eee;
}

body.tema-oscuro h2 { color: #66b0ff; }

body.tema-oscuro .productos-grid, 
body.tema-oscuro .producto-card,
body.tema-oscuro .carrito, 
body.tema-oscuro .form-entrega,
body.tema-oscuro .pedidos {
    background-color: #2c2c2c;
    color: #eee;
}

body.tema-oscuro th {
    background-color: #444;
    color: #fff;
}

body.tema-oscuro td, body.tema-oscuro th { border-color: #555; }

body.tema-oscuro .producto-card button { background-color: #28a745; color: #fff; }
body.tema-oscuro .carrito button { background-color: #dc3545; color: #fff; }
body.tema-oscuro #finalizar, body.tema-oscuro #guardar-entrega { background-color: #5555ff; }
</style>
</head>

<body>
<header>
  <h1>üõçÔ∏è Tienda Virtual & Env√≠os üöö</h1>
  <div class="header-buttons">
    <button id="btnSalir">Salir</button>
    <button id="btnTema">üåô Tema Oscuro</button>
  </div>
</header>

<main>
  <div id="productos-container" class="productos-grid"></div>

  <section class="carrito">
    <h2>üõí Carrito de Compras</h2>
    <ul id="lista-carrito"></ul>
    <p class="total">Total: $<span id="total">0</span></p>
    <button id="finalizar">Finalizar Compra</button>
  </section>

  <section class="form-entrega" style="display:none;">
    <h2>Datos de Entrega</h2>
    <input type="text" id="nombre" placeholder="Nombre completo" required>
    <input type="text" id="direccion" placeholder="Direcci√≥n" required>
    <input type="text" id="telefono" placeholder="Tel√©fono" required>
    <input type="email" id="correo" placeholder="Correo electr√≥nico" required>
    <button id="guardar-entrega">Confirmar Pedido</button>
  </section>

 <section class="pedidos">
  <h2>üì¶ Mis Pedidos</h2>
  <table>
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Direcci√≥n</th>
        <th>Tel√©fono</th>
        <th>Correo</th>
        <th>Estado</th>
        <th>Conductor</th>
      </tr>
    </thead>
    <tbody id="lista-pedidos"></tbody>
  </table>
</section>
</main>

<script>
const API_URL = "http://localhost:4000";
let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

// ------------------ GUARDAR / CARGAR TEMA ------------------
function aplicarTemaGuardado() {
  const tema = localStorage.getItem("tema") || "claro";
  if (tema === "oscuro") {
    document.body.classList.add("tema-oscuro");
    document.getElementById("btnTema").textContent = " ‚òÄÔ∏è Tema Claro";
  } else {
    document.body.classList.remove("tema-oscuro");
    document.getElementById("btnTema").textContent = " üåô Tema Oscuro";
  }
}

// ------------------ PRODUCTOS ------------------
async function cargarProductos() {
  const res = await fetch(`${API_URL}/productos`);
  const productos = await res.json();
  const container = document.getElementById("productos-container");
  container.innerHTML = "";
  productos.forEach(prod => {
    container.innerHTML += `
      <div class="producto-card">
        <img src="${API_URL}${prod.imagen}" alt="${prod.nombre}">
        <h3>${prod.nombre}</h3>
        <p><b>$${prod.precio}</b></p>
        <p>Stock: ${prod.cantidad}</p>
        <p>${prod.descripcion}</p>
        <input type="number" id="cantidad-${prod.id}" value="1" min="1" max="${prod.cantidad}">
        <button onclick="agregarAlCarrito(${prod.id}, '${prod.nombre}', ${prod.precio}, ${prod.cantidad})">Agregar</button>
      </div>`;
  });
}

// ------------------ CARRITO ------------------
function agregarAlCarrito(id, nombre, precio, stock) {
  const cantidadInput = document.getElementById(`cantidad-${id}`);
  let cantidad = parseInt(cantidadInput.value);
  if (cantidad > stock) { alert("No puedes agregar m√°s de lo disponible en stock."); return; }
  if (cantidad > 0) {
    const index = carrito.findIndex(item => item.id === id);
    if (index > -1) {
      if (carrito[index].cantidad + cantidad > stock) { alert("Cantidad supera el stock disponible."); return; }
      carrito[index].cantidad += cantidad;
    } else { carrito.push({ id, nombre, precio, cantidad }); }
    localStorage.setItem("carrito", JSON.stringify(carrito));
    renderCarrito();
  }
}

function renderCarrito() {
  const lista = document.getElementById("lista-carrito");
  const totalElem = document.getElementById("total");
  lista.innerHTML = "";
  let suma = 0;
  carrito.forEach((item, i) => {
    suma += item.precio * item.cantidad;
    const li = document.createElement("li");
    li.innerHTML = `${item.nombre} x ${item.cantidad} - $${(item.precio * item.cantidad).toFixed(2)}
      <button onclick="eliminarDelCarrito(${i})">‚ùå</button>`;
    lista.appendChild(li);
  });
  totalElem.textContent = suma.toFixed(2);
}

function eliminarDelCarrito(index) {
  carrito.splice(index, 1);
  localStorage.setItem("carrito", JSON.stringify(carrito));
  renderCarrito();
}

// ------------------ PEDIDOS ------------------
document.getElementById("finalizar").addEventListener("click", () => {
  if (carrito.length === 0) { alert("Carrito vac√≠o"); return; }
  document.querySelector(".form-entrega").style.display = "block";
});

document.getElementById("guardar-entrega").addEventListener("click", async () => {
  const nombre = document.getElementById("nombre").value.trim();
  const direccion = document.getElementById("direccion").value.trim();
  const telefono = document.getElementById("telefono").value.trim();
  const correo = document.getElementById("correo").value.trim();
  if (!nombre || !direccion || !telefono || !correo) { alert("Completa todos los campos"); return; }

  let errores = false;
  for (let item of carrito) {
    const res = await fetch(`${API_URL}/pedidos`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        producto_id: item.id,
        nombre_producto: item.nombre,
        cantidad: item.cantidad,
        nombre,
        direccion,
        telefono,
        correo,
        estado: "Pendiente",
        conductor: ""
      })
    });
    if (!res.ok) errores = true;
  }

  if (!errores) {
    alert("Pedido registrado con √©xito ‚úÖ");
    carrito = [];
    localStorage.removeItem("carrito");
    renderCarrito();
    document.querySelector(".form-entrega").style.display = "none";
    cargarPedidos();
  } else {
    alert("Error al registrar alguno de los productos del pedido");
  }
});

async function cargarPedidos() {
  const res = await fetch(`${API_URL}/pedidos`);
  const pedidos = await res.json();
  const tbody = document.getElementById("lista-pedidos");
  tbody.innerHTML = "";
  pedidos.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.cliente}</td>
      <td>${p.producto}</td>
      <td>${p.cantidad}</td>
      <td>${p.direccion}</td>
      <td>${p.telefono}</td>
      <td>${p.correo}</td>
      <td>${p.estado}</td>
      <td>${p.conductor || "Sin asignar"}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ------------------ BOT√ìN SALIR ------------------
document.getElementById("btnSalir").addEventListener("click", () => {
  localStorage.clear();
  window.location.href = "login.html";
});

// ------------------ BOT√ìN CAMBIAR TEMA ------------------
const btnTema = document.getElementById("btnTema");
btnTema.addEventListener("click", () => {
  document.body.classList.toggle("tema-oscuro");
  if (document.body.classList.contains("tema-oscuro")) {
    localStorage.setItem("tema", "oscuro");
    btnTema.textContent = " ‚òÄÔ∏è Tema Claro";
  } else {
    localStorage.setItem("tema", "claro");
    btnTema.textContent = " üåô Tema Oscuro";
  }
});

// ------------------ INICIO ------------------
aplicarTemaGuardado();
cargarProductos();
renderCarrito();
cargarPedidos();
</script>
</body>
</html>
